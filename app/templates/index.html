<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinDebug Pro (é…ç½®åŒ–+åˆ†é¡µå®Œæ•´ç‰ˆ)</title>
    <style>
        /* ================= æ ·å¼ä¿æŒä¸å˜ (æºè‡ª index222) ================= */
        :root {
            --primary: #1677ff;
            --primary-hover: color-mix(in srgb, var(--primary), white 20%);
            --sidebar-bg: #001529;
            --bg-body: #f0f2f5;
            --text-main: #333;
            --border-color: #e5e7eb;
            --success: #52c41a;
            --danger: #ff4d4f;
            --processing: #1677ff;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        .sidebar { width: 256px; background-color: var(--sidebar-bg); color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { height: 64px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; background: #002140; }
        .nav-menu { flex: 1; padding: 16px 0; }
        .nav-item { display: flex; align-items: center; padding: 12px 24px; color: #a6adb4; text-decoration: none; cursor: pointer; transition: 0.3s; margin-bottom: 4px; }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { background: var(--primary); color: white; border-right: 4px solid #fff; }
        .nav-icon { margin-right: 10px; font-size: 16px; }

        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: 64px; background: white; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 24px; flex-shrink: 0; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 24px; }
        .container { max-width: 1200px; margin: 0 auto; }

        .card { background: white; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 24px; overflow: hidden; }
        .card-header { padding: 16px 24px; border-bottom: 1px solid #f0f0f0; font-weight: 600; font-size: 16px; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 24px; }

        .form-grid { display: flex; flex-wrap: wrap; gap: 24px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
        .label { font-size: 14px; font-weight: 500; color: #1f2937; }
        .input, .select { height: 36px; padding: 0 12px; border: 1px solid #d9d9d9; border-radius: 6px; width: 100%; outline: none; transition: 0.2s; font-size: 14px; }
        .input:focus, .select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(22, 119, 255, 0.1); }

        .switch-wrapper { display: flex; align-items: center; height: 36px; }
        .switch-label { position: relative; display: inline-block; width: 44px; height: 22px; margin-right: 8px; vertical-align: middle; }
        .switch-label input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .switch-label input:checked + .slider { background-color: var(--primary); }
        .switch-label input:checked + .slider:before { transform: translateX(22px); }

        .btn-submit { background: var(--primary); color: white; border: none; padding: 8px 24px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 14px; min-width: 120px; justify-content: center; }
        .btn-submit:hover { background: var(--primary-hover); }
        .btn-submit.running { background: var(--processing); opacity: 1; cursor: wait; }
        .btn-submit.running:hover { background: var(--danger) !important; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 14px 16px; background: #fafafa; border-bottom: 1px solid #f0f0f0; font-size: 13px; color: #666; white-space: nowrap; }
        td { padding: 14px 16px; border-bottom: 1px solid #f0f0f0; font-size: 13px; color: #333; }
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; border: 1px solid transparent; }
        .status-processing { color: var(--processing); background: #e6f7ff; border-color: #91caff; }
        .status-success { color: var(--success); background: #f6ffed; border-color: #b7eb8f; }
        .status-stopped { color: var(--danger); background: #fff1f0; border-color: #ffa39e; }

        /* å¢åŠ å·¥å…·æ ä¸åˆ†é¡µæ ·å¼ */
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
        .search-input { width: 300px; height: 36px; padding: 0 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px; outline: none; }
        .search-btn { height: 36px; padding: 0 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; }

        .pagination { display: flex; justify-content: flex-end; align-items: center; padding: 16px 24px; gap: 10px; font-size: 13px; color: #666; }
        .page-btn { padding: 4px 12px; border: 1px solid #d9d9d9; background: white; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #f5f5f5; }
        .page-btn:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); }
        .page-size-select { padding: 4px 8px; border: 1px solid #d9d9d9; border-radius: 4px; outline: none; }

        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 90; display: none; }
        .drawer { position: fixed; top: 0; right: 0; bottom: 0; width: 700px; background: #f5f7fa; z-index: 100; transform: translateX(100%); transition: 0.3s; display: flex; flex-direction: column; box-shadow: -4px 0 16px rgba(0,0,0,0.1); }
        .drawer.open { transform: translateX(0); }
        .drawer-overlay.open { display: block; }
        .detail-header { background: white; padding: 32px 40px; border-bottom: 1px solid #e8e8e8; }

        .stepper { display: flex; justify-content: space-between; position: relative; }
        .step-item { position: relative; z-index: 2; text-align: center; flex: 1; display: flex; flex-direction: column; align-items: center; }
        .step-dot { width: 14px; height: 14px; background: white; border-radius: 50%; margin-bottom: 12px; border: 2px solid #e8e8e8; transition: 0.3s; position: relative; z-index: 2; }
        .step-title { font-size: 14px; color: #999; font-weight: 500; margin-bottom: 4px; }
        .step-user { font-size: 12px; color: #666; }
        .step-time { font-size: 12px; color: #bbb; margin-top: 2px; }
        .step-line { position: absolute; top: 7px; left: 50%; width: 100%; height: 2px; background: #e8e8e8; z-index: 1; }
        .step-item:last-child .step-line { display: none; }

        .step-item.active .step-dot { background: var(--primary); border-color: var(--primary); box-shadow: 0 0 0 3px rgba(22,119,255,0.2); transform: scale(1.1); }
        .step-item.active .step-title { color: #333; font-weight: bold; }
        .step-item.finish .step-dot { background: white; border-color: var(--primary); }
        .step-item.finish .step-dot::after { content:''; display:block; width:6px; height:6px; background:var(--primary); border-radius:50%; position:absolute; top:2px; left:2px; }
        .step-item.finish .step-title { color: #333; }
        .step-item.finish .step-line { background: var(--primary); }

        .info-card { background: white; margin: 20px; border-radius: 8px; padding: 24px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .info-title { font-size: 16px; font-weight: bold; margin-bottom: 24px; color: #333; border-left: 4px solid var(--primary); padding-left: 12px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px 40px; }
        .info-item { display: flex; }
        .info-label { width: 100px; color: #888; font-size: 14px; }
        .info-value { flex: 1; color: #333; font-size: 14px; font-weight: 500; word-break: break-all; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">FinDebug</div>
        <nav class="nav-menu" id="nav-menu"></nav>
    </aside>

    <div class="main-content">
        <header class="header">
            <h2 id="page-title" style="font-size:18px;">ä»ªè¡¨ç›˜</h2>
        </header>

        <main class="content-scroll" id="main-container"></main>
    </div>

    <div class="drawer-overlay" id="drawer-overlay" onclick="App.closeDrawer()"></div>
    <div class="drawer" id="drawer">
        <div class="detail-header">Ã¥Ã¥
            <h3 style="margin-bottom: 24px; font-size: 16px; color:#333;">æµç¨‹è¿›åº¦</h3>
            <div id="drawer-stepper" class="stepper"></div>
        </div>
        <div style="flex: 1; overflow-y: auto;">
            <div class="info-card">
                <div class="info-title">ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</div>
                <div id="drawer-info-grid" class="info-grid"></div>
            </div>
        </div>
    </div>

<script>
    // ================= 1. é…ç½®æ•°æ® (NavConfig & Pages) =================
    // å®šä¹‰ä¾§è¾¹æ å¯¼èˆª
    const NavConfig = [
        { key: 'dashboard', title: 'è´·æ¬¾è¿›ä»¶æ¨¡æ‹Ÿ', icon: 'ğŸ“Š', type: 'form' },
        { key: 'history', title: 'å†å²è®°å½•æŸ¥è¯¢', icon: 'ğŸ“œ', type: 'table' }
    ];

    // å®šä¹‰é¡µé¢å…·ä½“é…ç½®
    const PageConfigs = {
        // ä»ªè¡¨ç›˜é…ç½® (è¡¨å• + æµç¨‹)
        dashboard: {
            title: 'è´·æ¬¾è¿›ä»¶æµç¨‹',
            desc: 'é…ç½®åŒ–ç”Ÿæˆè¡¨å•ï¼Œæ”¯æŒæœ¬åœ°ä¼šè¯è®°å½•åˆ†é¡µã€‚',
            fields: [
                { name: 'name', label: 'ç”¨æˆ·å§“å', type: 'text', width: '30%', defaultValue: 'ä»˜å°å°' },
                { name: 'idCard', label: 'èº«ä»½è¯å·', type: 'text', width: '30%', defaultValue: '3321944288191034921' },
                { name: 'mobile', label: 'è”ç³»æ–¹å¼', type: 'text', width: '30%', defaultValue: '18112345678' },
                { name: 'address', label: 'è”ç³»åœ°å€', type: 'text', width: '100%', defaultValue: 'æµ™æ±Ÿçœæ­å·å¸‚è¥¿æ¹–åŒºé»„å§‘å±±è·¯å·¥ä¸“è·¯äº¤å‰å£' },
                { name: 'amount', label: 'ç”³è¯·é‡‘é¢', type: 'number', width: '30%', defaultValue: 50000 },
                { name: 'terms', label: 'åˆ†æœŸæœŸæ•°', type: 'select', width: '30%', defaultValue:'12',options: ['12æœŸ', '24æœŸ', '36æœŸ'], },
                { name: 'isUrgent', label: 'åŠ æ€¥å¤„ç†', type: 'switch', width: '30%', defaultValue: true }
            ],
            workflow: [
                { title: 'åˆ›å»ºé¡¹ç›®', user: 'æ›²ä¸½ä¸½' },
                { title: 'éƒ¨é—¨åˆå®¡', user: 'å‘¨æ¯›æ¯›' },
                { title: 'è´¢åŠ¡å¤æ ¸', user: 'è´¢åŠ¡å¤„' },
                { title: 'å®Œæˆ', user: 'ç³»ç»Ÿ' }
            ]
        },
        // å†å²è®°å½•é¡µé…ç½® (ä»…ä½œä¸ºå ä½ï¼Œé€»è¾‘åœ¨ renderHistory ä¸­)
        history: {
            title: 'æ‰€æœ‰å†å²æ‰§è¡Œè®°å½•'
        }
    };

    // ================= 2. æ¨¡æ‹Ÿåç«¯ (MockBackend - æ”¯æŒæœç´¢ä¸åˆ†é¡µ) =================
    const MockBackend = {
        tasks: {},     // å­˜æ´»çš„ä»»åŠ¡
        historyDB: [], // å†å²æ•°æ®åº“ (æ¨¡æ‹ŸæŒä¹…åŒ–)

        init() {
            // åˆå§‹åŒ–ç”Ÿæˆ 55 æ¡å†å²å‡æ•°æ®ï¼Œç”¨äºæµ‹è¯•åˆ†é¡µ
            for(let i=0; i<55; i++) {
                this.historyDB.push({
                    taskId: 'H-2023-' + (1000+i),
                    status: i%3===0 ? 'PROCESSING' : (i%5===0?'STOPPED':'SUCCESS'),
                    formData: { name: 'æ¨¡æ‹Ÿç”¨æˆ·'+i, amount: 10000 + i*100 },
                    startTime: new Date(Date.now() - i * 3600000)
                });
            }
        },

        createTask(formData, workflow) {
            const taskId = 'T-' + Math.floor(Math.random()*100000);
            const task = {
                taskId, formData, status: 'PROCESSING', stepIndex: 0, workflow, startTime: new Date()
            };
            this.tasks[taskId] = task;
            this.historyDB.unshift(task); // åŒæ—¶å†™å…¥å†å²
            this.runTaskBackground(taskId);
            return taskId;
        },

        runTaskBackground(taskId) {
            let task = this.tasks[taskId];
            const totalSteps = task.workflow.length;
            let timer = setInterval(() => {
                if (!this.tasks[taskId] || this.tasks[taskId].status === 'STOPPED') { clearInterval(timer); return; }
                if (task.stepIndex < totalSteps - 1) {
                    task.stepIndex++;
                } else {
                    task.status = 'SUCCESS';
                    clearInterval(timer);
                }
            }, 2000);
        },

        queryTask(taskId) {
            // ä¼˜å…ˆæŸ¥å®æ—¶ï¼Œæ²¡æœ‰æŸ¥å†å²
            return this.tasks[taskId] || this.historyDB.find(t=>t.taskId === taskId);
        },

        stopTask(taskId) {
            if (this.tasks[taskId]) this.tasks[taskId].status = 'STOPPED';
        },

        // æ¨¡æ‹Ÿåç«¯åˆ†é¡µæŸ¥è¯¢
        searchHistory(page, size, keyword) {
            let filtered = this.historyDB;
            if(keyword) {
                filtered = filtered.filter(item =>
                    item.taskId.includes(keyword) ||
                    item.formData.name.includes(keyword)
                );
            }
            const total = filtered.length;
            const start = (page - 1) * size;
            const end = start + size;
            const rows = filtered.slice(start, end);
            return { total, rows };
        }
    };
    MockBackend.init(); // å¯åŠ¨æ—¶å¡«å……å‡æ•°æ®

    // ================= 3. API æœåŠ¡å±‚ (çº¯ Promise å°è£…) =================
    const ApiService = {
        async submit(formData) {
            const res = await fetch('/api/loan/apply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            return await res.json();
        },
        async pollStatus(taskId) {
            const res = await fetch(`/api/status?taskId=${taskId}`);
            return await res.json();
        },
        async stop(taskId) {
            await fetch('/api/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ taskId })
            });
        },
        async getHistory(page, size, keyword) {
            const res = await fetch(`/api/history?page=${page}&size=${size}&keyword=${encodeURIComponent(keyword)}`);
            return await res.json();
        },
    };

    // ================= 4. å…¨å±€çŠ¶æ€ç®¡ç† (State) =================
    const State = {
        currentNav: 'dashboard', // å½“å‰é€‰ä¸­çš„å¯¼èˆª dashboard | history

        // ä»ªè¡¨ç›˜çŠ¶æ€ (Dashboard)
        dashboard: {
            formData: {},
            records: [], // æœ¬åœ°ä¼šè¯è®°å½•
            pagination: { current: 1, size: 5 } // æœ¬åœ°åˆ†é¡µé…ç½®
        },

        // å†å²é¡µçŠ¶æ€ (History)
        history: {
            data: [],    // åˆ—è¡¨æ•°æ®
            total: 0,
            loading: false,
            keyword: '',
            pagination: { current: 1, size: 10 } // æœåŠ¡ç«¯åˆ†é¡µé…ç½®
        }
    };

    // ================= 5. æ ¸å¿ƒæ§åˆ¶å™¨ (App Controller) =================
    const App = {
        pollingId: null,
        currentTaskId: null,

        init() {
            this.renderSidebar();
            this.switchNav('dashboard');
        },

        // æ¸²æŸ“ä¾§è¾¹æ 
        renderSidebar() {
            const navHtml = NavConfig.map(nav => `
                <div class="nav-item ${nav.key === State.currentNav ? 'active' : ''}"
                     onclick="App.switchNav('${nav.key}')">
                    <span class="nav-icon">${nav.icon}</span> ${nav.title}
                </div>
            `).join('');
            document.getElementById('nav-menu').innerHTML = navHtml;
        },

        // åˆ‡æ¢å¯¼èˆª
        switchNav(key) {
            State.currentNav = key;
            this.renderSidebar(); // æ›´æ–°é«˜äº®
            document.getElementById('page-title').innerText = PageConfigs[key].title;

            // è·¯ç”±åˆ†å‘
            const navItem = NavConfig.find(n => n.key === key);
            const container = document.getElementById('main-container');

            if (navItem.type === 'form') {
                this.renderDashboard(container);
            } else if (navItem.type === 'table') {
                this.renderHistoryView(container);
                this.loadHistoryData(); // åˆ‡è¿‡æ¥æ—¶è‡ªåŠ¨åŠ è½½
            }
        },

        // --- A. æ¸²æŸ“ä»ªè¡¨ç›˜ (Form + Local Table) ---
        renderDashboard(container) {
            const config = PageConfigs['dashboard'];
            const { formData } = State.dashboard;

            // åˆå§‹åŒ–é»˜è®¤å€¼
            config.fields.forEach(f => {
                if (formData[f.name] === undefined) formData[f.name] = f.defaultValue;
            });

            // ç”Ÿæˆè¡¨å• HTML
            const formHtml = config.fields.map(f => {
                let input = '';
                if (f.type === 'select') {
                    input = `<select class="select" onchange="State.dashboard.formData['${f.name}']=this.value">${f.options.map(o=>`<option>${o}</option>`).join('')}</select>`;
                } else if (f.type === 'switch') {
                    input = `<div class="switch-wrapper"><label class="switch-label"><input type="checkbox" ${formData[f.name]?'checked':''} onchange="State.dashboard.formData['${f.name}']=this.checked"><span class="slider"></span></label></div>`;
                } else {
                    input = `<input class="input" type="${f.type}" value="${formData[f.name]}" oninput="State.dashboard.formData['${f.name}']=this.value">`;
                }
                return `<div class="form-group" style="width:${f.width}"><label class="label">${f.label}</label>${input}</div>`;
            }).join('');

            container.innerHTML = `
                <div class="container">
                    <div class="card">
                        <div class="card-header">${config.title}</div>
                        <div class="card-body">
                            <p style="color:#666;margin-bottom:20px;font-size:14px;">${config.desc}</p>
                            <div class="form-grid">${formHtml}</div>
                            <div style="margin-top:24px;text-align:right;">
                                <button id="action-btn" class="btn-submit" onclick="App.handleDashboardAction()">
                                    <span>â–¶ æäº¤å¹¶æ‰§è¡Œ</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">æœ¬æ¬¡ä¼šè¯è®°å½•</div>
                        <div class="card-body" style="padding:0">
                            <table id="dash-table"><thead><tr><th>çŠ¶æ€</th><th>ä¸šåŠ¡ID</th><th>ç”³è¯·äºº</th><th>å¼€å§‹æ—¶é—´</th><th>å½“å‰èŠ‚ç‚¹</th><th>æ“ä½œ</th></tr></thead><tbody id="dash-tbody"></tbody></table>
                            <div class="pagination" id="dash-pagination"></div>
                        </div>
                    </div>
                </div>`;

            this.renderDashboardTable();
            this.renderDashboardBtn();
        },

        // æ¸²æŸ“ä»ªè¡¨ç›˜è¡¨æ ¼ (å«æœ¬åœ°åˆ†é¡µé€»è¾‘)
        renderDashboardTable() {
            const tbody = document.getElementById('dash-tbody');
            const pgContainer = document.getElementById('dash-pagination');
            if(!tbody) return;

            const { records, pagination } = State.dashboard;
            const start = (pagination.current - 1) * pagination.size;
            const pageData = records.slice(start, start + pagination.size);

            if(records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:#999">æš‚æ— è®°å½•</td></tr>';
                pgContainer.innerHTML = '';
            } else {
                tbody.innerHTML = pageData.map(r => this.buildRow(r)).join('');
                this.renderPaginationControl(pgContainer, pagination.current, records.length, pagination.size, (newPage) => {
                    State.dashboard.pagination.current = newPage;
                    this.renderDashboardTable();
                });
            }
        },

        // --- B. æ¸²æŸ“å†å²è®°å½•é¡µ (Search + Server Table) ---
        renderHistoryView(container) {
            container.innerHTML = `
                <div class="container">
                    <div class="card">
                        <div class="card-header">å†å²è®°å½•æŸ¥è¯¢</div>
                        <div class="card-body">
                            <div class="toolbar">
                                <input type="text" id="hist-search" class="search-input" placeholder="è¾“å…¥ç”³è¯·äººå§“åæˆ–ä¸šåŠ¡ID..." value="${State.history.keyword}">
                                <button class="search-btn" onclick="App.handleHistorySearch()">æŸ¥è¯¢</button>
                            </div>

                            <table>
                                <thead><tr><th>çŠ¶æ€</th><th>ä¸šåŠ¡ID</th><th>ç”³è¯·äºº</th><th>å¼€å§‹æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                                <tbody id="hist-tbody"></tbody>
                            </table>

                            <div class="pagination" id="hist-pagination"></div>
                        </div>
                    </div>
                </div>`;
        },

        async loadHistoryData() {
            const tbody = document.getElementById('hist-tbody');
            if(!tbody) return;

            // Loading çŠ¶æ€
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:24px;">åŠ è½½ä¸­...</td></tr>';

            const { pagination, keyword } = State.history;
            const res = await ApiService.getHistory({
                page: pagination.current,
                size: pagination.size,
                keyword
            });

            State.history.data = res.rows;
            State.history.total = res.total;
            this.renderHistoryTable();
        },

        renderHistoryTable() {
            const tbody = document.getElementById('hist-tbody');
            const pgContainer = document.getElementById('hist-pagination');
            if(!tbody) return;

            if(State.history.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:24px;color:#999">æœªæ‰¾åˆ°åŒ¹é…æ•°æ®</td></tr>';
            } else {
                tbody.innerHTML = State.history.data.map(r => `
                    <tr>
                        <td>${this.getStatusBadge(r.status)}</td>
                        <td style="font-family:monospace">${r.taskId}</td>
                        <td>${r.formData.name || '-'}</td>
                        <td>${new Date(r.startTime).toLocaleString()}</td>
                        <td><a href="javascript:;" onclick="App.openDrawer('${r.taskId}', true)" style="color:var(--primary)">è¯¦æƒ…</a></td>
                    </tr>
                `).join('');
            }

            // æ¸²æŸ“æœåŠ¡ç«¯åˆ†é¡µæ§ä»¶
            this.renderPaginationControl(pgContainer, State.history.pagination.current, State.history.total, State.history.pagination.size, (newPage) => {
                State.history.pagination.current = newPage;
                this.loadHistoryData();
            });
        },

        handleHistorySearch() {
            State.history.keyword = document.getElementById('hist-search').value;
            State.history.pagination.current = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            this.loadHistoryData();
        },

        // --- é€šç”¨åˆ†é¡µæ§ä»¶æ¸²æŸ“å™¨ ---
        renderPaginationControl(container, current, total, size, onPageChange) {
            const maxPage = Math.ceil(total / size) || 1;

            // ä¸ºäº†æŠŠå‡½æ•°ä¼ ç»™ onclickï¼Œæˆ‘ä»¬éœ€è¦æŒ‚è½½åˆ° window æˆ–è€…ä½¿ç”¨é—­åŒ…ç»‘å®š
            // è¿™é‡Œä½¿ç”¨ä¸€ä¸ªç®€å•æŠ€å·§ï¼šé‡æ–°ç»‘å®š global handler
            window._tempPageHandler = onPageChange;

            container.innerHTML = `
                <span>å…± ${total} æ¡</span>
                <button class="page-btn" ${current<=1?'disabled':''} onclick="window._tempPageHandler(${current-1})">ä¸Šä¸€é¡µ</button>
                <span>ç¬¬ ${current} / ${maxPage} é¡µ</span>
                <button class="page-btn" ${current>=maxPage?'disabled':''} onclick="window._tempPageHandler(${current+1})">ä¸‹ä¸€é¡µ</button>
            `;
        },

        // --- ä¸šåŠ¡é€»è¾‘ï¼šæäº¤ä¸è½®è¯¢ ---
        async handleDashboardAction() {
            if (this.currentTaskId) {
                // åœæ­¢
                if(confirm('ç¡®å®šåœæ­¢å½“å‰ä»»åŠ¡ï¼Ÿ')) await ApiService.stop(this.currentTaskId);
            } else {
                // æäº¤
                const config = PageConfigs['dashboard'];
                const { formData } = State.dashboard;

                try {
                    const res = await ApiService.submit(formData, config.workflow);
                    this.currentTaskId = res.taskId;

                    // æ·»åŠ æœ¬åœ°è®°å½•
                    const newRecord = {
                        taskId: this.currentTaskId,
                        formData: {...formData},
                        status: 'PROCESSING',
                        currentStepIndex: 0,
                        steps: config.workflow,
                        startTime: new Date()
                    };
                    State.dashboard.records.unshift(newRecord);
                    State.dashboard.pagination.current = 1; // å›åˆ°ç¬¬ä¸€é¡µ

                    this.renderDashboardTable();
                    this.renderDashboardBtn();
                    this.startPolling(this.currentTaskId);
                } catch(e) { alert('æäº¤å¤±è´¥'); }
            }
        },

        startPolling(taskId) {
            if(this.pollingId) clearInterval(this.pollingId);
            this.pollingId = setInterval(async () => {
                const data = await ApiService.pollStatus(taskId);
                this.updateLocalRecord(taskId, data);
                if(data.status !== 'PROCESSING') this.stopPolling();
            }, 1000);
        },

        stopPolling() {
            if(this.pollingId) { clearInterval(this.pollingId); this.pollingId = null; }
            this.currentTaskId = null;
            this.renderDashboardBtn();
        },

        updateLocalRecord(taskId, data) {
            const rec = State.dashboard.records.find(r => r.taskId === taskId);
            if(rec) {
                rec.status = data.status;
                rec.currentStepIndex = data.currentStepIndex;
                this.renderDashboardTable(); // åˆ·æ–°è¡¨æ ¼

                // åˆ·æ–°æŠ½å±‰
                const drawer = document.getElementById('drawer');
                if(drawer.classList.contains('open') && drawer.dataset.tid === taskId) {
                    this.renderDrawerContent(rec);
                }
            }
        },

        renderDashboardBtn() {
            const btn = document.getElementById('action-btn');
            if(!btn) return;
            if(this.currentTaskId) {
                btn.classList.add('running');
                btn.innerHTML = 'â³ æ‰§è¡Œä¸­...';
                btn.onmouseenter = () => btn.innerHTML = 'â›” ç‚¹å‡»åœæ­¢';
                btn.onmouseleave = () => btn.innerHTML = 'â³ æ‰§è¡Œä¸­...';
            } else {
                btn.classList.remove('running');
                btn.innerHTML = 'â–¶ æäº¤å¹¶æ‰§è¡Œ';
                btn.onmouseenter = null;
            }
        },

        // --- æŠ½å±‰é€»è¾‘ ---
        async openDrawer(taskId, fromServer = false) {
            let record;
            if(fromServer) {
                // å¦‚æœæ˜¯å†å²è®°å½•ï¼Œéœ€è¦é‡æ–°æŸ¥ä¸€ä¸‹è¯¦æƒ…ï¼ˆä¸ºäº†è·å–æ­¥éª¤ä¿¡æ¯ï¼‰
                const res = await ApiService.pollStatus(taskId);
                record = {
                    taskId,
                    status: res.status,
                    currentStepIndex: res.currentStepIndex || 0,
                    steps: res.steps || PageConfigs.dashboard.workflow, // å†å²æ•°æ®å¯èƒ½ç¼º workflowï¼Œç”¨é»˜è®¤è¡¥
                    formData: res.formData || {}
                };
            } else {
                record = State.dashboard.records.find(r => r.taskId === taskId);
            }

            if(!record) return;

            const drawer = document.getElementById('drawer');
            drawer.dataset.tid = taskId;
            this.renderDrawerContent(record);
            document.getElementById('drawer-overlay').classList.add('open');
            drawer.classList.add('open');
        },

        closeDrawer() {
            document.getElementById('drawer-overlay').classList.remove('open');
            document.getElementById('drawer').classList.remove('open');
        },

        renderDrawerContent(record) {
            // æ­¥éª¤æ¡
            const stepper = document.getElementById('drawer-stepper');
            const total = record.steps.length;
            stepper.innerHTML = record.steps.map((step, idx) => {
                let cls = '';
                if(record.status === 'SUCCESS' || idx < record.currentStepIndex) cls = 'finish';
                else if(idx === record.currentStepIndex && record.status === 'PROCESSING') cls = 'active';

                let lineStyle = (idx < total - 1 && (cls === 'finish' || (cls === 'active' && record.status==='SUCCESS')))
                    ? 'background:#1677ff' : '';

                return `<div class="step-item ${cls}">
                    <div class="step-line" style="${lineStyle}"></div>
                    <div class="step-dot"></div>
                    <div class="step-title">${step.title}</div>
                    <div class="step-user">${step.user||'ç³»ç»Ÿ'}</div>
                </div>`;
            }).join('');

            // ä¿¡æ¯ç½‘æ ¼
            const grid = document.getElementById('drawer-info-grid');
            const labels = {}; // ç®€å•çš„ Label æ˜ å°„
            PageConfigs.dashboard.fields.forEach(f => labels[f.name] = f.label);

            grid.innerHTML = Object.keys(record.formData).map(k => `
                <div class="info-item">
                    <div class="info-label">${labels[k]||k}ï¼š</div>
                    <div class="info-value">${record.formData[k]}</div>
                </div>
            `).join('');
        },

        // è¾…åŠ©ï¼šçŠ¶æ€å¾½æ ‡
        getStatusBadge(status) {
            if(status === 'PROCESSING') return `<span class="status-badge status-processing">æ‰§è¡Œä¸­</span>`;
            if(status === 'SUCCESS') return `<span class="status-badge status-success">å·²å®Œæˆ</span>`;
            return `<span class="status-badge status-stopped">å·²åœæ­¢</span>`;
        },

        // è¾…åŠ©ï¼šæ„å»ºè¡¨æ ¼è¡Œ
        buildRow(r) {
            let node = (r.steps && r.steps[r.currentStepIndex]) ? r.steps[r.currentStepIndex].title : 'ç»“æŸ';
            if(r.status === 'SUCCESS') node = 'æµç¨‹ç»“æŸ';
            return `<tr>
                <td>${this.getStatusBadge(r.status)}</td>
                <td style="font-family:monospace">${r.taskId}</td>
                <td>${r.formData.name}</td>
                <td>${r.startTime.toLocaleTimeString()}</td>
                <td>${node}</td>
                <td><a href="javascript:;" onclick="App.openDrawer('${r.taskId}')" style="color:var(--primary)">è¯¦æƒ…</a></td>
            </tr>`;
        }
    };

    // å¯åŠ¨åº”ç”¨
    App.init();

</script>
</body>
</html>